#!/bin/bash

##
## clone the master directory if necessary
##
if [ ! -d ${WORKING_DIR}/../git ]
then
  clone "https://github.com/apache/cassandra.git" ${WORKING_DIR}/../git
  if [ $? -ne 0 ]
	then
		echo "git master clone failed"
		exit 1
	fi
fi

## update the master directory
cd ${WORKING_DIR}/../git
git fetch --all --tags

## ensure that subsequent get calls checkout from the git directory
GIT_ARGS="-l ${WORKING_DIR}/../git cassandra"

## Set the default java home
if [ -z "$JAVA_HOME" ]
then
    export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64
fi

if [ ! -d ${WORKING_DIR}/build-image ]
then
	echo "directory ${WORKING_DIR}/build-image does not exist"
	exit 1
fi
cd ${WORKING_DIR}/build-image

if [ ! -d cassandra ]
then
	git clone $GIT_ARGS
	if [ $? -ne 0 ]
	then
		echo "git clone failed"
		exit 1
	fi
fi

cd cassandra

git checkout $BRANCH

ant realclean
ant
if [ $? -ne 0 ]
then
	echo "ant build failed"
	exit 1
fi

cd -

tar -czf cassandra.tar.gz  --exclude-vcs cassandra
